{"version":3,"file":"usePayrollData-DIt-ymzP.js","sources":["../../src/hooks/usePayrollData.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { PayrollData } from '@/types/dashboard';\n\nconst GOOGLE_CONFIG = {\n  CLIENT_ID: \"416630995185-g7b0fm679lb4p45p5lou070cqscaalaf.apps.googleusercontent.com\",\n  CLIENT_SECRET: \"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\",\n  REFRESH_TOKEN: \"1//04yfYtJTsGbluCgYIARAAGAQSNwF-L9Ir3g0kqAfdV7MLUcncxyc5-U0rp2T4rjHmGaxLUF3PZy7VX8wdumM8_ABdltAqXTsC6sk\",\n  TOKEN_URL: \"https://oauth2.googleapis.com/token\"\n};\n\nconst SPREADSHEET_ID = \"1DSRuJJBhl1Sc9yfY6ki-ZFhdmQ_OeVeGyPDE6n9zpK4\";\n\nexport const usePayrollData = () => {\n  const [data, setData] = useState<PayrollData[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const getAccessToken = async () => {\n    try {\n      const response = await fetch(GOOGLE_CONFIG.TOKEN_URL, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n        body: new URLSearchParams({\n          client_id: GOOGLE_CONFIG.CLIENT_ID,\n          client_secret: GOOGLE_CONFIG.CLIENT_SECRET,\n          refresh_token: GOOGLE_CONFIG.REFRESH_TOKEN,\n          grant_type: 'refresh_token',\n        }),\n      });\n      const tokenData = await response.json();\n      return tokenData.access_token as string;\n    } catch (error) {\n      console.error('Error getting access token:', error);\n      throw error;\n    }\n  };\n\n  const parseNumericValue = (value: string | number): number => {\n    // Accept numbers directly\n    if (typeof value === 'number') {\n      // Sheets with UNFORMATTED_VALUE will already give numbers\n      return isNaN(value) ? 0 : value;\n    }\n    if (!value || value === '') return 0;\n    // Strip everything except digits, minus and decimal point\n    const cleaned = value.toString().replace(/[^0-9.-]/g, '');\n    const parsed = parseFloat(cleaned);\n    return isNaN(parsed) ? 0 : parsed;\n  };\n\n  const fetchPayrollData = async () => {\n    try {\n      // Fetching payroll data from Google Sheets\n      setIsLoading(true);\n      const accessToken = await getAccessToken();\n      const response = await fetch(\n        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Payroll?valueRenderOption=UNFORMATTED_VALUE&dateTimeRenderOption=FORMATTED_STRING`,\n        { headers: { Authorization: `Bearer ${accessToken}` } }\n      );\n\n      if (!response.ok) {\n        throw new Error(`Failed to fetch payroll data: ${response.status} ${response.statusText}`);\n      }\n\n      const result = await response.json();\n      const rows: any[] = result.values || [];\n      if (rows.length < 2) {\n        setData([]);\n        setError(null);\n        return;\n      }\n\n  const payrollData: PayrollData[] = rows.slice(1).map((row: any[]) => {\n        const cycleSessions = parseNumericValue(row[4]);\n        const emptyCycleSessions = parseNumericValue(row[5]);\n        const nonEmptyCycleSessions = parseNumericValue(row[6]);\n        const cycleCustomers = parseNumericValue(row[7]);\n        const cyclePaid = parseNumericValue(row[8]);\n\n        const strengthSessions = parseNumericValue(row[9]);\n        const emptyStrengthSessions = parseNumericValue(row[10]);\n        const nonEmptyStrengthSessions = parseNumericValue(row[11]);\n        const strengthCustomers = parseNumericValue(row[12]);\n        const strengthPaid = parseNumericValue(row[13]);\n\n        const barreSessions = parseNumericValue(row[14]);\n        const emptyBarreSessions = parseNumericValue(row[15]);\n        const nonEmptyBarreSessions = parseNumericValue(row[16]);\n        const barreCustomers = parseNumericValue(row[17]);\n        const barrePaid = parseNumericValue(row[18]);\n\n        const totalSessions = parseNumericValue(row[19]);\n        const totalEmptySessions = parseNumericValue(row[20]);\n        const totalNonEmptySessions = parseNumericValue(row[21]);\n        const totalCustomers = parseNumericValue(row[22]);\n        const totalPaid = parseNumericValue(row[23]);\n\n  const converted = parseNumericValue(row[26]);\n  // Normalize percentage-like fields: Sheets UNFORMATTED_VALUE returns 0-1 for % cells\n  const conversionRateRaw = parseNumericValue(row[27]);\n  const conversionRate = conversionRateRaw <= 1 && conversionRateRaw > 0 ? conversionRateRaw * 100 : conversionRateRaw;\n  const retained = parseNumericValue(row[28]);\n  const retentionRateRaw = parseNumericValue(row[29]);\n  const retentionRate = retentionRateRaw <= 1 && retentionRateRaw > 0 ? retentionRateRaw * 100 : retentionRateRaw;\n  const newMembers = parseNumericValue(row[30]);\n\n        return {\n          teacherId: row[0] || '',\n          teacherName: row[1] || '',\n          teacherEmail: row[2] || '',\n          location: row[3] || '',\n\n          cycleSessions,\n          emptyCycleSessions,\n          nonEmptyCycleSessions,\n          cycleCustomers,\n          cyclePaid,\n\n          strengthSessions,\n          emptyStrengthSessions,\n          nonEmptyStrengthSessions,\n          strengthCustomers,\n          strengthPaid,\n\n          barreSessions,\n          emptyBarreSessions,\n          nonEmptyBarreSessions,\n          barreCustomers,\n          barrePaid,\n\n          totalSessions,\n          totalEmptySessions,\n          totalNonEmptySessions,\n          totalCustomers,\n          totalPaid,\n\n          monthYear: row[24] || '',\n          unique: row[25] || '',\n          converted,\n          // Store human-readable strings for compatibility, ensure one decimal place\n          conversion: `${conversionRate.toFixed(1)}%`,\n          retained,\n          retention: `${retentionRate.toFixed(1)}%`,\n          new: newMembers,\n          conversionRate,\n          retentionRate,\n          classAverageInclEmpty: totalSessions > 0 ? totalCustomers / totalSessions : 0,\n          classAverageExclEmpty: totalNonEmptySessions > 0 ? totalCustomers / totalNonEmptySessions : 0,\n        } as PayrollData;\n      });\n\n      setData(payrollData);\n      setError(null);\n    } catch (err) {\n      console.error('Error fetching payroll data:', err);\n      setError('Failed to load payroll data');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchPayrollData();\n  }, []);\n\n  return { data, isLoading, error, refetch: fetchPayrollData };\n};\n"],"names":["GOOGLE_CONFIG","SPREADSHEET_ID","usePayrollData","data","setData","useState","isLoading","setIsLoading","error","setError","getAccessToken","parseNumericValue","value","cleaned","parsed","fetchPayrollData","accessToken","response","rows","payrollData","row","cycleSessions","emptyCycleSessions","nonEmptyCycleSessions","cycleCustomers","cyclePaid","strengthSessions","emptyStrengthSessions","nonEmptyStrengthSessions","strengthCustomers","strengthPaid","barreSessions","emptyBarreSessions","nonEmptyBarreSessions","barreCustomers","barrePaid","totalSessions","totalEmptySessions","totalNonEmptySessions","totalCustomers","totalPaid","converted","conversionRateRaw","conversionRate","retained","retentionRateRaw","retentionRate","newMembers","useEffect"],"mappings":"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"}