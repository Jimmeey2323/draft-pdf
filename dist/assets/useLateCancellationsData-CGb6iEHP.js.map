{"version":3,"file":"useLateCancellationsData-CGb6iEHP.js","sources":["../../src/hooks/useLateCancellationsData.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { LateCancellationsData } from '@/types/dashboard';\nimport { fetchGoogleSheet, parseNumericValue } from '@/utils/googleAuth';\nimport { createLogger } from '@/utils/logger';\n\nconst logger = createLogger('useLateCancellationsData');\n\nconst SPREADSHEET_ID = import.meta.env.VITE_GOOGLE_PAYROLL_SPREADSHEET_ID || \"1DSRuJJBhl1Sc9yfY6ki-ZFhdmQ_OeVeGyPDE6n9zpK4\";\n\nexport const useLateCancellationsData = () => {\n  const [data, setData] = useState<LateCancellationsData[]>([]);\n  // New: retain all raw checkins (unfiltered) for additional analytics\n  const [allCheckins, setAllCheckins] = useState<any[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const fetchLateCancellationsData = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      logger.info('Fetching late cancellations data from Google Sheets...');\n      \n      const rows = await fetchGoogleSheet(SPREADSHEET_ID, 'Checkins');\n      \n      logger.info('Late cancellations fetch result:', {\n        status: 'success',\n        rowsReceived: rows.length,\n        sheetId: SPREADSHEET_ID\n      });\n      \n      if (rows.length < 2) {\n        logger.warn('No data rows found in Checkins sheet');\n        setData([]);\n        setAllCheckins([]);\n        return;\n      }\n\n  // Process the Checkins data: build both raw checkins and late cancellations subsets\n  const processedData: LateCancellationsData[] = [];\n  const rawCheckins: any[] = [];\n      \n      const headers = rows[0];\n      \n      // Log headers for debugging\n      logger.info('Checkins sheet headers:', headers);\n      \n      // Find column indices by name (case-insensitive search)\n      const findIndex = (name: string) => headers.findIndex((h: string) => h?.toLowerCase() === name.toLowerCase());\n      \n      const memberIdIndex = findIndex('Member ID');\n      const firstNameIndex = findIndex('First Name');\n      const lastNameIndex = findIndex('Last Name');\n      const emailIndex = findIndex('Email');\n      const locationIndex = findIndex('Location');\n      const sessionNameIndex = findIndex('Session Name');\n      const teacherNameIndex = findIndex('Teacher Name');\n      const cleanedProductIndex = findIndex('Cleaned Product');\n      const cleanedCategoryIndex = findIndex('Cleaned Category');\n      const cleanedClassIndex = findIndex('Cleaned Class');\n      const paymentMethodIndex = findIndex('Payment Method Name');\n      const dateIndex = findIndex('Date (IST)');\n      const dayOfWeekIndex = findIndex('Day of Week');\n      const timeIndex = findIndex('Time');\n      const durationIndex = findIndex('Duration (Minutes)');\n      const capacityIndex = findIndex('Capacity');\n      const monthIndex = findIndex('Month');\n      const yearIndex = findIndex('Year');\n      const paidIndex = findIndex('Paid');\n      const isNewIndex = findIndex('Is New');\n      const isLateCancelledIndex = findIndex('Is Late Cancelled');\n      \n      if (isLateCancelledIndex === -1) {\n        logger.error('Is Late Cancelled column not found in headers:', headers);\n        setData([]);\n        setAllCheckins([]);\n        return;\n      }\n\n      logger.info('Column indices found:', {\n        memberIdIndex, firstNameIndex, lastNameIndex, emailIndex, locationIndex,\n        sessionNameIndex, teacherNameIndex, cleanedProductIndex, cleanedCategoryIndex,\n        cleanedClassIndex, paymentMethodIndex, dateIndex, dayOfWeekIndex, timeIndex,\n        durationIndex, capacityIndex, monthIndex, yearIndex, paidIndex, isNewIndex,\n        isLateCancelledIndex\n      });\n\n      // Process data rows (skip header)\n      for (let i = 1; i < rows.length; i++) {\n        const row = rows[i];\n        \n        // Skip empty rows\n        if (!row || row.length === 0) continue;\n        \n        // Build raw checkin row (unfiltered)\n        const rawRow = {\n          memberId: memberIdIndex >= 0 ? row[memberIdIndex] : '',\n          firstName: firstNameIndex >= 0 ? row[firstNameIndex] : '',\n          lastName: lastNameIndex >= 0 ? row[lastNameIndex] : '',\n          email: emailIndex >= 0 ? row[emailIndex] : '',\n          location: locationIndex >= 0 ? row[locationIndex] : '',\n          sessionName: sessionNameIndex >= 0 ? row[sessionNameIndex] : '',\n          teacherName: teacherNameIndex >= 0 ? row[teacherNameIndex] : '',\n          cleanedProduct: cleanedProductIndex >= 0 ? row[cleanedProductIndex] : '',\n          cleanedCategory: cleanedCategoryIndex >= 0 ? row[cleanedCategoryIndex] : '',\n          cleanedClass: cleanedClassIndex >= 0 ? row[cleanedClassIndex] : '',\n          paymentMethodName: paymentMethodIndex >= 0 ? row[paymentMethodIndex] : '',\n          dateIST: dateIndex >= 0 ? row[dateIndex] : '',\n          dayOfWeek: dayOfWeekIndex >= 0 ? row[dayOfWeekIndex] : '',\n          time: timeIndex >= 0 ? row[timeIndex] : '',\n          duration: durationIndex >= 0 ? parseNumericValue(row[durationIndex]) : 0,\n          capacity: capacityIndex >= 0 ? parseNumericValue(row[capacityIndex]) : 0,\n          month: monthIndex >= 0 ? row[monthIndex] : '',\n          year: yearIndex >= 0 ? parseNumericValue(row[yearIndex]) : 0,\n          paidAmount: paidIndex >= 0 ? parseNumericValue(row[paidIndex]) : 0,\n          isNew: isNewIndex >= 0 ? row[isNewIndex] : '',\n          isLateCancelled: isLateCancelledIndex >= 0 ? row[isLateCancelledIndex] : 'FALSE',\n        };\n        rawCheckins.push(rawRow);\n        \n        // Only include rows where Is Late Cancelled = TRUE (case-insensitive, trimmed)\n        const isLateCancelled = isLateCancelledIndex >= 0 ? String(row[isLateCancelledIndex]).trim().toUpperCase() : '';\n        \n        // Log first 10 rows for debugging\n        if (i <= 10) {\n          logger.info(`Row ${i} - Is Late Cancelled value: \"${row[isLateCancelledIndex]}\" (normalized: \"${isLateCancelled}\")`);\n        }\n        \n        if (isLateCancelled !== 'TRUE') continue;\n        \n        const dataRow: LateCancellationsData = {\n          memberId: memberIdIndex >= 0 ? row[memberIdIndex] : '',\n          firstName: firstNameIndex >= 0 ? row[firstNameIndex] : '',\n          lastName: lastNameIndex >= 0 ? row[lastNameIndex] : '',\n          email: emailIndex >= 0 ? row[emailIndex] : '',\n          location: locationIndex >= 0 ? row[locationIndex] : '',\n          sessionName: sessionNameIndex >= 0 ? row[sessionNameIndex] : '',\n          teacherName: teacherNameIndex >= 0 ? row[teacherNameIndex] : '',\n          cleanedProduct: cleanedProductIndex >= 0 ? row[cleanedProductIndex] : '',\n          cleanedCategory: cleanedCategoryIndex >= 0 ? row[cleanedCategoryIndex] : '',\n          cleanedClass: cleanedClassIndex >= 0 ? row[cleanedClassIndex] : '',\n          paymentMethodName: paymentMethodIndex >= 0 ? row[paymentMethodIndex] : '',\n          dateIST: dateIndex >= 0 ? row[dateIndex] : '',\n          dayOfWeek: dayOfWeekIndex >= 0 ? row[dayOfWeekIndex] : '',\n          time: timeIndex >= 0 ? row[timeIndex] : '',\n          duration: durationIndex >= 0 ? parseNumericValue(row[durationIndex]) : 0,\n          capacity: capacityIndex >= 0 ? parseNumericValue(row[capacityIndex]) : 0,\n          month: monthIndex >= 0 ? row[monthIndex] : '',\n          year: yearIndex >= 0 ? parseNumericValue(row[yearIndex]) : 0,\n          paidAmount: paidIndex >= 0 ? parseNumericValue(row[paidIndex]) : 0,\n          isNew: isNewIndex >= 0 ? row[isNewIndex] : '',\n          tableType: 'checkins'\n        };\n        \n        processedData.push(dataRow);\n      }\n\n      // Collect sample values from Is Late Cancelled column for debugging\n      const lateCancelledSamples = [];\n      for (let i = 1; i < Math.min(20, rows.length); i++) {\n        lateCancelledSamples.push({\n          row: i,\n          value: rows[i][isLateCancelledIndex],\n          normalized: String(rows[i][isLateCancelledIndex]).trim().toUpperCase()\n        });\n      }\n      \n      logger.info('Processed late cancellations data:', {\n        totalRecords: processedData.length,\n        totalRawCheckins: rawCheckins.length,\n        isLateCancelledColumnIndex: isLateCancelledIndex,\n        lateCancelledValueSamples: lateCancelledSamples,\n        sample: processedData.slice(0, 3)\n      });\n      \n      setData(processedData);\n      setAllCheckins(rawCheckins);\n      setError(null);\n    } catch (err) {\n      const errorMsg = err instanceof Error ? err.message : String(err);\n      logger.error('Error fetching late cancellations data:', {\n        error: errorMsg,\n        spreadsheetId: SPREADSHEET_ID,\n        sheetName: 'Checkins',\n        errorType: err instanceof Error ? err.constructor.name : typeof err\n      });\n      setError(`Failed to load late cancellations data: ${errorMsg}`);\n      setData([]);\n      setAllCheckins([]);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchLateCancellationsData();\n  }, []);\n\n  return { data, allCheckins, loading, error, refetch: fetchLateCancellationsData };\n};\n"],"names":["logger","createLogger","SPREADSHEET_ID","useLateCancellationsData","data","setData","useState","allCheckins","setAllCheckins","loading","setLoading","error","setError","fetchLateCancellationsData","rows","fetchGoogleSheet","processedData","rawCheckins","headers","findIndex","name","h","memberIdIndex","firstNameIndex","lastNameIndex","emailIndex","locationIndex","sessionNameIndex","teacherNameIndex","cleanedProductIndex","cleanedCategoryIndex","cleanedClassIndex","paymentMethodIndex","dateIndex","dayOfWeekIndex","timeIndex","durationIndex","capacityIndex","monthIndex","yearIndex","paidIndex","isNewIndex","isLateCancelledIndex","i","row","rawRow","parseNumericValue","isLateCancelled","dataRow","lateCancelledSamples","err","errorMsg","useEffect"],"mappings":"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"}