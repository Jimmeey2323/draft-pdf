{"version":3,"file":"useNewClientData-Dl1VV2C_.js","sources":["../../src/hooks/useNewClientData.ts"],"sourcesContent":["\nimport { useState, useEffect } from 'react';\nimport { NewClientData } from '@/types/dashboard';\nimport { parseDate } from '@/utils/dateUtils';\nimport { fetchGoogleSheet, SPREADSHEET_IDS } from '@/utils/googleAuth';\nimport { createLogger } from '@/utils/logger';\n\nconst logger = createLogger('useNewClientData');\n\nexport const useNewClientData = () => {\n  const [data, setData] = useState<NewClientData[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [isInitialized, setIsInitialized] = useState(false);\n\n  // Helper to calculate conversion span in days\n  const calculateConversionSpan = (firstVisitDate: string, firstPurchaseDate: string): number => {\n    if (!firstVisitDate || !firstPurchaseDate) {\n      return 0;\n    }\n    \n    const firstVisit = parseDate(firstVisitDate);\n    const firstPurchase = parseDate(firstPurchaseDate);\n    if (!firstVisit || !firstPurchase) return 0;\n    \n    const diffTime = firstPurchase.getTime() - firstVisit.getTime();\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n    return Math.max(0, diffDays);\n  };\n\n  // Helper to format to canonical month key YYYY-MM\n  const getMonthYear = (dateStr: string = ''): string => {\n    const d = parseDate(dateStr);\n    if (!d) return '';\n    const year = d.getFullYear();\n    const month = (d.getMonth() + 1).toString().padStart(2, '0');\n    return `${year}-${month}`;\n  };\n\n  const fetchNewClientData = async () => {\n    try {\n      if (isInitialized) {\n        setLoading(true);\n      }\n      logger.info('Fetching new client data...');\n      \n      const rows = await fetchGoogleSheet(SPREADSHEET_IDS.PAYROLL, 'New', {\n        valueRenderOption: 'FORMATTED_VALUE'\n      });\n\n      if (rows.length < 2) {\n        setData([]);\n        return;\n      }\n\n      const newClientData: NewClientData[] = rows.slice(1).map((row: any[]) => {\n        // Column mapping aligned to provided sample:\n        // 0 Member Id, 1 First Name, 2 Last Name, 3 Email, 4 Phone Number,\n        // 5 First Visit Date, 6 First Visit Entity Name, 7 First Visit Type, 8 First Visit Location,\n        // 9 Payment Method, 10 Membership Used, 11 Home Location, 12 Class No, 13 Trainer Name,\n        // 14 Is New, 15 Visits Post Trial, 16 Memberships Bought Post Trial, 17 Purchase Count Post Trial,\n        // 18 Ltv, 19 Retention Status, 20 Conversion Status, 21 First Purchase Date,\n        // 22 No of Visits, 23 Conversion Span (Days), 24 Month Year (if present)\n\n        const firstVisitDate: string = row[5] || '';\n        const firstPurchaseDate: string = row[21] || '';\n        const sheetConversionSpan = typeof row[23] !== 'undefined' ? Number(row[23]) : undefined;\n        const monthYearSheet: string = row[24] || '';\n        const noOfVisits = typeof row[22] !== 'undefined' ? Number(row[22]) : undefined;\n\n        const conversionSpan = (sheetConversionSpan && !isNaN(sheetConversionSpan))\n          ? sheetConversionSpan\n          : calculateConversionSpan(firstVisitDate, firstPurchaseDate);\n\n        return {\n          memberId: row[0] || '',\n          firstName: row[1] || '',\n          lastName: row[2] || '',\n          email: row[3] || '',\n          phoneNumber: row[4] || '',\n          firstVisitDate,\n          firstVisitEntityName: row[6] || '',\n          firstVisitType: row[7] || '',\n          firstVisitLocation: row[8] || '',\n          paymentMethod: row[9] || '',\n          membershipUsed: row[10] || '',\n          homeLocation: row[11] || '',\n          classNo: parseFloat(row[12]) || 0,\n          trainerName: row[13] || '',\n          isNew: row[14] || '',\n          visitsPostTrial: parseFloat(row[15]) || 0,\n          membershipsBoughtPostTrial: row[16] || '',\n          purchaseCountPostTrial: parseFloat(row[17]) || 0,\n          ltv: parseFloat(row[18]) || 0,\n          retentionStatus: row[19] || '',\n          conversionStatus: row[20] || '',\n          firstPurchase: firstPurchaseDate,\n          // Canonical month key from sheet if provided else derived\n          monthYear: monthYearSheet || getMonthYear(firstVisitDate),\n          conversionSpan,\n          // Optional: bring in noOfVisits for downstream use\n          noOfVisits,\n        } as NewClientData & { noOfVisits?: number };\n      });\n\n      logger.info(`New client data loaded: ${newClientData.length} records`);\n      \n      setData(newClientData);\n      setError(null);\n      setIsInitialized(true);\n    } catch (err) {\n      logger.error('Error fetching new client data:', err);\n      setError('Failed to load new client data');\n      setIsInitialized(true);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    if (!isInitialized) {\n      fetchNewClientData();\n    }\n  }, [isInitialized]);\n\n  return { data, loading, error, refetch: fetchNewClientData };\n};\n"],"names":["logger","createLogger","useNewClientData","data","setData","useState","loading","setLoading","error","setError","isInitialized","setIsInitialized","calculateConversionSpan","firstVisitDate","firstPurchaseDate","firstVisit","parseDate","firstPurchase","diffTime","diffDays","getMonthYear","dateStr","d","year","month","fetchNewClientData","rows","fetchGoogleSheet","SPREADSHEET_IDS","newClientData","row","sheetConversionSpan","monthYearSheet","noOfVisits","conversionSpan","useEffect"],"mappings":"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"}