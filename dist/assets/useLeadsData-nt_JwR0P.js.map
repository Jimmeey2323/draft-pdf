{"version":3,"file":"useLeadsData-nt_JwR0P.js","sources":["../../src/hooks/useLeadsData.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\nimport { LeadsData } from '@/types/leads';\nimport { getGoogleAccessToken } from '@/utils/googleAuth';\nimport { createLogger } from '@/utils/logger';\n\nconst logger = createLogger('useLeadsData');\nconst SPREADSHEET_ID = \"1mqjZXStj_PeCt_exDSk-1RP-20Jgk0yl1Lmcg3sZty8\";\n\nexport const parseDate = (dateString: string | undefined | null) => {\n  if (!dateString || dateString.trim() === '' || dateString === '-') return '';\n  \n  try {\n    let parsedDate;\n    const now = new Date();\n    \n    // Handle various date formats\n    if (dateString.includes('/')) {\n      // Handle DD/MM/YYYY or MM/DD/YYYY format\n      const parts = dateString.split('/');\n      if (parts.length === 3) {\n        const day = parseInt(parts[0]);\n        const month = parseInt(parts[1]);\n        const year = parseInt(parts[2]);\n        \n        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {\n          // Assume DD/MM/YYYY format for consistency\n          parsedDate = new Date(year, month - 1, day);\n        }\n      }\n    } else if (dateString.includes('-')) {\n      // YYYY-MM-DD format\n      parsedDate = new Date(dateString);\n    } else {\n      // Try direct parsing\n      parsedDate = new Date(dateString);\n    }\n    \n    // Validate the date and ensure it's not in the future or too far in the past\n    if (!parsedDate || isNaN(parsedDate.getTime())) {\n      return '';\n    }\n    \n    // Exclude dates that are in the future or before 2020\n    if (parsedDate > now || parsedDate.getFullYear() < 2020) {\n      return '';\n    }\n    \n    // Return ISO string format for consistency\n    return parsedDate.toISOString();\n  } catch (error) {\n    return '';\n  }\n};\n\nconst safeGet = (row: any[], index: number): string => {\n  return row && row[index] !== undefined && row[index] !== null ? String(row[index]).trim() : '';\n};\n\nconst safeGetNumber = (row: any[], index: number): number => {\n  let value = safeGet(row, index);\n  if (!value) return 0;\n  // Guard against date-like and non-numeric strings in numeric fields\n  if (value.includes('/') || value.includes('-')) return 0;\n  // Strip currency symbols/commas\n  value = value.replace(/[₹$,]/g, '');\n  const parsed = parseFloat(value);\n  return isNaN(parsed) ? 0 : parsed;\n};\n\nconst safeGetInt = (row: any[], index: number): number => {\n  const value = safeGet(row, index);\n  if (!value) return 0;\n  // Date-like string should not be parsed as int\n  if (value.includes('/') || value.includes('-')) return 0;\n  const parsed = parseInt(value, 10);\n  return isNaN(parsed) ? 0 : parsed;\n};\n\nexport const useLeadsData = () => {\n  const [data, setData] = useState<LeadsData[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const fetchLeadsData = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      \n      const accessToken = await getGoogleAccessToken();\n      \n      const sheetName = encodeURIComponent('◉ Leads');\n      const response = await fetch(\n        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}?alt=json`,\n        {\n          headers: {\n            'Authorization': `Bearer ${accessToken}`,\n          },\n        }\n      );\n\n      if (!response.ok) {\n        throw new Error(`Failed to fetch leads data: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n      const rows = result.values || [];\n      \n      logger.info(`Fetched ${rows.length} rows from leads sheet`);\n      \n      if (rows.length < 2) {\n        setData([]);\n        return;\n      }\n\n      // Process each row with defensive programming\n      const leadsData: LeadsData[] = rows.slice(1)\n        .map((row: any[], index: number) => {\n          try {\n            if (!row || row.length === 0) {\n              return null;\n            }\n\n            const leadData: LeadsData = {\n              id: safeGet(row, 0),\n              fullName: safeGet(row, 1),\n              phone: safeGet(row, 2),\n              email: safeGet(row, 3),\n              createdAt: parseDate(safeGet(row, 4)),\n              sourceId: safeGet(row, 5),\n              source: safeGet(row, 6),\n              memberId: safeGet(row, 7),\n              convertedToCustomerAt: parseDate(safeGet(row, 8)),\n              stage: safeGet(row, 9),\n              associate: safeGet(row, 10),\n              remarks: safeGet(row, 11),\n              followUp1Date: parseDate(safeGet(row, 12)),\n              followUpComments1: safeGet(row, 13),\n              followUp2Date: parseDate(safeGet(row, 14)),\n              followUpComments2: safeGet(row, 15),\n              followUp3Date: parseDate(safeGet(row, 16)),\n              followUpComments3: safeGet(row, 17),\n              followUp4Date: parseDate(safeGet(row, 18)),\n              followUpComments4: safeGet(row, 19),\n              center: safeGet(row, 20),\n              classType: safeGet(row, 21),\n              hostId: safeGet(row, 22),\n              status: safeGet(row, 23),\n              channel: safeGet(row, 24),\n              period: safeGet(row, 25),\n              purchasesMade: safeGetInt(row, 26),\n              ltv: safeGetNumber(row, 27),\n              visits: safeGetInt(row, 28),\n              trialStatus: safeGet(row, 29),\n              conversionStatus: safeGet(row, 30),\n              retentionStatus: safeGet(row, 31),\n            };\n\n            return leadData;\n          } catch (rowError) {\n            logger.error(`Error processing row ${index + 1}:`, rowError);\n            return null;\n          }\n        })\n        .filter((item): item is LeadsData => item !== null);\n\n      logger.info(`Processed ${leadsData.length} leads`);\n      \n      setData(leadsData);\n      setError(null);\n    } catch (err) {\n      logger.error('Error fetching leads data:', err);\n      setError(err instanceof Error ? err.message : 'Failed to load leads data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchLeadsData();\n  }, []);\n\n  return { data, loading, error, refetch: fetchLeadsData };\n};\n"],"names":["logger","createLogger","SPREADSHEET_ID","parseDate","dateString","parsedDate","now","parts","day","month","year","safeGet","row","index","safeGetNumber","value","parsed","safeGetInt","useLeadsData","data","setData","useState","loading","setLoading","error","setError","fetchLeadsData","accessToken","getGoogleAccessToken","sheetName","response","rows","leadsData","rowError","item","err","useEffect"],"mappings":"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"}