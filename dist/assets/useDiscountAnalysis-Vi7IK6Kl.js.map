{"version":3,"file":"useDiscountAnalysis-Vi7IK6Kl.js","sources":["../../src/hooks/useDiscountAnalysis.ts"],"sourcesContent":["import { useState, useEffect, useMemo } from 'react';\n// Assuming useGoogleSheets hook is in this path\nimport { useGoogleSheets } from './useGoogleSheets';\n\n// Updated interface to match all columns in the sample data\nexport interface DiscountAnalysisData {\n  memberId: string;\n  customerName: string;\n  customerEmail: string;\n  saleItemId: string;\n  paymentCategory: string;\n  paymentDate: string;\n  paymentValue: number;\n  paidInMoneyCredits: number;\n  paymentVat: number;\n  paymentItem: string;\n  cleanedProduct?: string;\n  cleanedCategory?: string;\n  mrpPostTax?: number;\n  discountAmount?: number;\n  discountPercentage?: number;\n  soldBy?: string;\n  location?: string;\n}\nexport const useDiscountAnalysis = () => {\n  const { data: salesData, loading, error } = useGoogleSheets();\n  const [discountData, setDiscountData] = useState<DiscountAnalysisData[]>([]);\n\n  useEffect(() => {\n    if (salesData && salesData.length > 0) {\n      try {\n        const parseNumber = (value: any): number => {\n          if (value === null || value === undefined || value === '') return 0;\n          // Handle string values with currency symbols or commas\n          const cleanValue = value.toString().replace(/[â‚¹,]/g, '').trim();\n          const num = parseFloat(cleanValue);\n          return isNaN(num) ? 0 : num;\n        };\n\n        const parseDate = (dateStr: string): string => {\n          if (!dateStr) return '';\n          try {\n            // Handle DD/MM/YYYY format\n            if (dateStr.includes('/')) {\n              const datePart = dateStr.split(',')[0].trim();\n              const [day, month, year] = datePart.split('/');\n              \n              if (day && month && year) {\n                const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n                return new Date(isoDate).toISOString().split('T')[0];\n              }\n            }\n            // Handle YYYY-MM-DD format\n            if (dateStr.includes('-')) {\n              const date = new Date(dateStr);\n              if (!isNaN(date.getTime())) {\n                return date.toISOString().split('T')[0];\n              }\n            }\n            return '';\n          } catch (e) {\n            console.error(`Date parsing error for value: \"${dateStr}\"`, e);\n            return '';\n          }\n        };\n        \n        // Process all sales data, not just discounted ones\n        const processedData: DiscountAnalysisData[] = salesData.map((item: any) => {\n          const discountAmount = parseNumber(item.discountAmount || item['Discount Amount -Mrp- Payment Value'] || 0);\n          const discountPercentage = parseNumber(item.discountPercentage || item['Discount Percentage - discount amount/mrp*100'] || 0);\n          \n          return {\n            memberId: item.memberId || item['Member ID']?.toString() || '',\n            customerName: item.customerName || item['Customer Name'] || '',\n            customerEmail: item.customerEmail || item['Customer Email'] || '',\n            saleItemId: item.saleItemId || item['Sale Item ID']?.toString() || '',\n            paymentCategory: item.paymentCategory || item['Payment Category'] || '',\n            paymentDate: parseDate(item.paymentDate || item['Payment Date'] || ''),\n            paymentValue: parseNumber(item.paymentValue || item['Payment Value'] || 0),\n            paidInMoneyCredits: parseNumber(item.paidInMoneyCredits || item['Paid In Money Credits'] || 0),\n            paymentVat: parseNumber(item.paymentVat || item['Payment VAT'] || 0),\n            paymentItem: item.paymentItem || item['Payment Item'] || '',\n            paymentMethod: item.paymentMethod || item['Payment Method'] || '',\n            paymentStatus: item.paymentStatus || item['Payment Status'] || '',\n            paymentTransactionId: item.paymentTransactionId || item['Payment Transaction ID']?.toString() || '',\n            stripeToken: item.stripeToken || item['Stripe Token'] || '',\n            saleReference: item.saleReference || item['Sale Reference']?.toString() || '',\n            soldBy: item.soldBy === '-' ? 'Online/System' : (item.soldBy || item['Sold By'] || 'Unknown'),\n            location: item.calculatedLocation || item['Calculated Location'] || '',\n            cleanedProduct: item.cleanedProduct || item['Cleaned Product'] || '',\n            cleanedCategory: item.cleanedCategory || item['Cleaned Category'] || '',\n            hostId: item.hostId || item['Host Id']?.toString() || '',\n            mrpPreTax: parseNumber(item.mrpPreTax || item['Mrp - Pre Tax'] || 0),\n            mrpPostTax: parseNumber(item.mrpPostTax || item['Mrp - Post Tax'] || 0),\n            discountAmount,\n            discountPercentage,\n            membershipType: item.membershipType || item['Membership Type']?.trim() || '',\n          };\n        });\n\n        setDiscountData(processedData);\n      } catch (error) {\n        console.error('Error processing discount data:', error);\n        setDiscountData([]);\n      }\n    } else {\n      // No sales data available for discount analysis\n      setDiscountData([]);\n    }\n  }, [salesData]);\n\n  const metrics = useMemo(() => {\n    if (!discountData.length) {\n      return {\n        totalDiscountAmount: 0,\n        totalRevenueLost: 0,\n        totalTransactions: 0,\n        avgDiscountPercentage: 0,\n        totalPotentialRevenue: 0,\n        totalActualRevenue: 0,\n        discountEffectiveness: 0,\n        productBreakdown: [],\n        monthlyBreakdown: [],\n      };\n    }\n\n    const totalDiscountAmount = discountData.reduce((sum, item) => sum + (item.discountAmount || 0), 0);\n    const totalTransactions = discountData.length;\n    const totalPotentialRevenue = discountData.reduce((sum, item) => sum + (item.mrpPostTax || item.paymentValue || 0), 0);\n    const totalActualRevenue = discountData.reduce((sum, item) => sum + (item.paymentValue || 0), 0);\n\n    // Calculate average discount percentage\n    const discountedItems = discountData.filter(item => (item.discountAmount || 0) > 0);\n    const avgDiscountPercentage = discountedItems.length > 0 \n      ? discountedItems.reduce((sum, item) => sum + (item.discountPercentage || 0), 0) / discountedItems.length \n      : 0;\n\n    // Group by product\n    const productBreakdown = discountData.reduce((acc, item) => {\n      const key = item.cleanedProduct || 'Unknown Product';\n      if (!acc[key]) {\n        acc[key] = {\n          product: key,\n          transactions: 0,\n          totalDiscount: 0,\n          avgDiscountPercentage: 0,\n          revenue: 0,\n          totalMrp: 0,\n        };\n      }\n      acc[key].transactions += 1;\n      acc[key].totalDiscount += item.discountAmount || 0;\n      acc[key].revenue += item.paymentValue || 0;\n      acc[key].totalMrp += item.mrpPostTax || item.paymentValue || 0;\n      return acc;\n    }, {} as Record<string, any>);\n\n    Object.values(productBreakdown).forEach((product: any) => {\n      product.avgDiscountPercentage = product.totalMrp > 0 ? (product.totalDiscount / product.totalMrp) * 100 : 0;\n    });\n\n    // Group by month\n    const monthlyBreakdown = discountData.reduce((acc, item) => {\n      if (!item.paymentDate) return acc;\n      const monthKey = item.paymentDate.substring(0, 7); // YYYY-MM\n      \n      if (!acc[monthKey]) {\n        acc[monthKey] = {\n          month: monthKey,\n          transactions: 0,\n          totalDiscount: 0,\n          revenue: 0,\n        };\n      }\n      acc[monthKey].transactions += 1;\n      acc[monthKey].totalDiscount += item.discountAmount || 0;\n      acc[monthKey].revenue += item.paymentValue || 0;\n      return acc;\n    }, {} as Record<string, any>);\n\n    return {\n      totalDiscountAmount,\n      totalRevenueLost: totalDiscountAmount,\n      totalTransactions,\n      avgDiscountPercentage,\n      totalPotentialRevenue,\n      totalActualRevenue,\n      discountEffectiveness: totalPotentialRevenue > 0 ? (totalActualRevenue / totalPotentialRevenue) * 100 : 0,\n      productBreakdown: Object.values(productBreakdown),\n      monthlyBreakdown: Object.values(monthlyBreakdown),\n    };\n  }, [discountData]);\n\n  return {\n    data: discountData,\n    metrics,\n    loading,\n    error,\n  };\n};"],"names":["useDiscountAnalysis","salesData","loading","error","useGoogleSheets","discountData","setDiscountData","useState","useEffect","parseNumber","value","cleanValue","num","parseDate","dateStr","datePart","day","month","year","isoDate","date","processedData","item","discountAmount","discountPercentage","metrics","useMemo","totalDiscountAmount","sum","totalTransactions","totalPotentialRevenue","totalActualRevenue","discountedItems","avgDiscountPercentage","productBreakdown","acc","key","product","monthlyBreakdown","monthKey"],"mappings":"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"}