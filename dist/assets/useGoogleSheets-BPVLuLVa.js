var v=Object.defineProperty;var _=(c,a,u)=>a in c?v(c,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):c[a]=u;var T=(c,a,u)=>_(c,typeof a!="symbol"?a+"":a,u);import{r as P}from"./index-Bm67KBkU.js";import{c as U,g as L,p as s}from"./googleAuth-BGo8ElRc.js";class H{constructor(a=6e4){T(this,"pending",new Map);T(this,"cache",new Map);T(this,"ttl");this.ttl=a}async fetch(a,u){const m=this.cache.get(a);if(m&&Date.now()-m.timestamp<this.ttl)return m.data;if(this.pending.has(a))return this.pending.get(a);const f=u().then(i=>(this.cache.set(a,{data:i,timestamp:Date.now()}),this.pending.delete(a),i)).catch(i=>{throw this.pending.delete(a),i});return this.pending.set(a,f),f}clear(){this.pending.clear(),this.cache.clear()}}const F=new H,D=U(),G="1HbGnJk-peffUp7XoXSlsL55924E9yUt8cP_h93cdTT0",k=()=>{const[c,a]=P.useState([]),[u,m]=P.useState(!0),[f,i]=P.useState(null),p=P.useRef(null),l=P.useRef(!0),M=async()=>{p.current&&p.current.abort(),p.current=new AbortController;try{m(!0),i(null);const r=(await F.fetch("google-sheets-sales",async()=>{D.info("Fetching sales data from Google Sheets...");const n=await L(),y=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${G}/values/Sales?alt=json`,{headers:{Authorization:`Bearer ${n}`},signal:p.current?.signal});if(!y.ok)throw new Error("Failed to fetch data");return y.json()})).values||[];if(r.length<2){l.current&&(a([]),m(!1));return}const h=r[0],d=[],S=200;for(let n=1;n<r.length;n+=S){if(!l.current)return;const y=Math.min(n+S,r.length),R=r.slice(n,y).map(w=>{const e={};h.forEach((g,E)=>{e[g]=w[E]||""});const t={memberId:e["Member ID"]||e.memberId||"",customerName:e["Customer Name"]||e.customerName||"",customerEmail:e["Customer Email"]||e.customerEmail||"",saleItemId:e["Sale Item ID"]||e.saleItemId||"",paymentCategory:e["Payment Category"]||e.paymentCategory||"",membershipType:e["Membership Type"]||e.membershipType||"",paymentDate:e["Payment Date"]||e.paymentDate||"",paymentValue:s(e["Payment Value"]||e.paymentValue||0),paidInMoneyCredits:s(e["Paid in Money Credits"]||e["Paid In Money Credits"]||e.paidInMoneyCredits||0),paymentVAT:s(e["Payment VAT"]||e.paymentVAT||0),paymentItem:e["Payment Item"]||e.paymentItem||"",paymentStatus:e["Payment Status"]||e.paymentStatus||"",paymentMethod:e["Payment Method"]||e.paymentMethod||"",paymentTransactionId:e["Payment Transaction ID"]||e.paymentTransactionId||"",stripeToken:e["Stripe Token"]||e.stripeToken||"",soldBy:e["Sold By"]||e.soldBy||"",saleReference:e["Sale Reference"]||e.saleReference||"",calculatedLocation:e["Calculated Location"]||e.calculatedLocation||"",cleanedProduct:e["Cleaned Product"]||e.cleanedProduct||"",cleanedCategory:e["Cleaned Category"]||e.cleanedCategory||"",netRevenue:s(e["Payment Value"]||e.paymentValue||0)-s(e["Payment VAT"]||e.paymentVAT||0),vat:s(e["Payment VAT"]||e.paymentVAT||0),grossRevenue:s(e["Payment Value"]||e.paymentValue||0),mrpPreTax:s(e["Mrp - Pre Tax"]||e["MRP Pre Tax"]||e.MRP_Pre_Tax||e.mrpPreTax||e.MrpPreTax||e["Pre Tax MRP"]||e["Sale Item Unit Price Excluding VAT"]||0),mrpPostTax:s(e["Mrp - Post Tax"]||e["MRP Post Tax"]||e.MRP_Post_Tax||e.mrpPostTax||e.MrpPostTax||e["Post Tax MRP"]||e["Sale Item Unit Price Including VAT"]||0),discountAmount:s(e["Discount Amount -Mrp- Payment Value"]||e["Discount Amount"]||e.discount_amount||e.discountAmount||e.DiscountAmount||e.Discount_Amount||e["Total Discount"]||e["Discount Value In Currency"]||e["Discount Value"]||e["Discount Value (In Currency)"]||e["Sale Total Discount Value"]||e["Sale Total Discount"]||e["Sale Item Unit Discount Value"]||0),discountPercentage:s(e["Discount Percentage - discount amount/mrp*100"]||e["Discount Percentage"]||e.discount_percentage||e.discountPercentage||e.DiscountPercentage||e.Discount_Percentage||e["Discount %"]||e.Discount_Percent||0),hostId:e["Host Id"]||e["Host ID"]||e.hostId||"",secMembershipStartDate:e["Sec. Membership Start Date"]||e["Sec Membership Start Date"]||"",secMembershipEndDate:e["Sec. Membership End Date"]||e["Sec Membership End Date"]||"",secMembershipTotalClasses:s(e["Sec. Membership Total Classes"]||0),secMembershipClassesLeft:s(e["Sec. Membership Classes Left"]||0),secMembershipUsedSessions:s(e["Sec. Total Used Sessions"]||e["Sec. Membership Used Sessions"]||0),discountType:e["Discount Code"]?"code":void 0,isPromotional:!!(e["Discount Code"]||e["Purchase Type"]==="promotional")},C=s(e["Sale Item Unit Discount Value"]||0),o=t.mrpPostTax&&t.mrpPostTax>0?t.mrpPostTax:t.mrpPreTax||0;if((t.discountAmount||0)<=0&&C>0&&(t.discountAmount=C),(t.discountAmount||0)<=0&&o>0&&(t.paymentValue||0)>0&&o>(t.paymentValue||0)&&(t.discountAmount=o-(t.paymentValue||0)),(t.discountAmount||0)<=0&&(t.discountPercentage||0)>0&&o>0&&(t.discountAmount=o*(t.discountPercentage||0)/100),(t.discountPercentage||0)<=0){if(o>0&&(t.discountAmount||0)>0)t.discountPercentage=t.discountAmount/o*100;else if(o>0&&(t.paymentValue||0)>0&&o>(t.paymentValue||0))t.discountPercentage=(o-(t.paymentValue||0))/o*100;else if((t.discountAmount||0)>0&&(t.paymentValue||0)>0){const g=(t.paymentValue||0)+(t.discountAmount||0);t.discountPercentage=g>0?(t.discountAmount||0)/g*100:0}}return typeof t.discountAmount=="number"&&(t.discountAmount=Math.round(t.discountAmount*100)/100),typeof t.discountPercentage=="number"&&(t.discountPercentage=Math.round(t.discountPercentage*100)/100),t});d.push(...R)}if(!l.current)return;D.debug("Transformed sales data sample:",d.slice(0,3));const x=d.filter(n=>(n.discountAmount||0)>0||(n.discountPercentage||0)>0),V=h.filter(n=>/discount/i.test(n)),A=h.filter(n=>/mrp|mrp post|mrp - post|post tax/i.test(n)),I={};r[1]&&h.forEach((n,y)=>{(V.includes(n)||A.includes(n))&&(I[n]=r[1][y]||null)}),D.info("useGoogleSheets - Data summary:",{totalRecords:d.length,recordsWithDiscounts:x.length,samplePaymentDates:d.slice(0,5).map(n=>n.paymentDate),sampleRawHeaders:h?h.slice(0,30):void 0,sampleRawRow:r[1]?r[1].slice(0,30):void 0,foundDiscountHeaders:V,foundMrpHeaders:A,sampleRowValuesForFoundHeaders:I,sampleDiscountData:d.slice(0,5).map(n=>({date:n.paymentDate,paymentValue:n.paymentValue,mrpPreTax:n.mrpPreTax,mrpPostTax:n.mrpPostTax,discountAmount:n.discountAmount,discountPercentage:n.discountPercentage,discountValueInCurrency:n["Discount Value In Currency"]||n.discountValueInCurrency||void 0,location:n.calculatedLocation}))}),a(d),i(null)}catch{l.current&&i("Failed to load sales data")}finally{l.current&&m(!1)}};return P.useEffect(()=>(l.current=!0,M(),()=>{l.current=!1,p.current&&p.current.abort()}),[]),{data:c,loading:u,error:f,refetch:M}};export{k as u};
//# sourceMappingURL=useGoogleSheets-BPVLuLVa.js.map
